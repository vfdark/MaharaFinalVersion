@model MaharaFinalVersion.Models.LiveSessionModel

@{
    ViewData["Title"] = "Ø¬Ù„Ø³Ø© Ù…Ø¨Ø§Ø´Ø±Ø© | Ù…Ù‡Ø§Ø±Ø©";
}

<link rel="stylesheet" href="~/css/live-session.css" />

<!-- âœ… Agora SDK (ONLY ONCE) -->
<script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>

<div class="live-session-page">

    <header>
        <h1>@Model.Title</h1>
        <h3>Ø§Ù„Ù…Ø¹Ù„Ù…: @Model.Instructor</h3>
    </header>

    <main class="session-container">

        <!-- ğŸ–¥ï¸ Screen Share Area -->
        <div id="screen-share" class="screen-share-area">
            <p id="screen-placeholder">Ù„Ù… ÙŠØªÙ… Ø¨Ø¯Ø¡ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø© Ø¨Ø¹Ø¯</p>
        </div>

        <!-- ğŸ‘¥ Participants -->
        <aside class="participants-list">
            <h2>Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙˆÙ†</h2>
            <ul id="participants">
                @foreach (var p in Model.Participants ?? new List<MaharaFinalVersion.Models.Participant>())
                {
                    <li class="@(p.IsSpeaking ? "speaking" : "")">
                        @if (p.IsHost)
                        {
                            <span class="host-badge">Ø§Ù„Ù…Ø¶ÙŠÙ</span>
                        }
                        @p.Name
                    </li>
                }
            </ul>
        </aside>

        <!-- ğŸ’¬ Chat -->
        <section class="chat-area">
            <h2>Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</h2>
            <div id="messages">
                @foreach (var msg in Model.Messages ?? new List<MaharaFinalVersion.Models.ChatMessage>())
                {
                    <p>@msg.Time - <strong>@msg.Sender:</strong> @msg.Message</p>
                }
            </div>
            <input type="text" id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." />
            <button id="sendBtn">Ø¥Ø±Ø³Ø§Ù„</button>
        </section>

    </main>

    <!-- ğŸ¥ Controls (Instructor Only) -->
    @if (Model.IsHost)
    {
        <div class="live-controls">
            <button class="btn btn-primary" onclick="startScreenShare()">ğŸ–¥ï¸ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø©</button>
            <button class="btn btn-danger" onclick="stopScreenShare()">â›” Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©</button>
        </div>
    }

</div>

<footer>
    &copy; 2026 Ù…Ù‡Ø§Ø±Ø© - Live Session. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.
    <a href="#">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©</a>
</footer>

<!-- ========================= -->
<!-- Agora Screen Share Logic -->
<!-- ========================= -->
<script>
    const APP_ID = "d0d5abfd738c42a2a956b631679d1971";
    const CHANNEL = "Mahara";
    const TOKEN = "007eJxTYLDYecAtcfFvhjXb3zs9LT45VS/CfXXBkjSlbXmuO17dPsStwJBikGKamJSWYm5skWxilGiUaGlqlmRmbGhmbpliaGlu+IM1NbMhkJFBWVaNiZEBAkF8NgbfxIzEokQGBgDmzSAI";

    const client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
    let screenTrack = null;

    async function startScreenShare() {
        try {
            await client.join(APP_ID, CHANNEL, TOKEN, null);

            screenTrack = await AgoraRTC.createScreenVideoTrack({
                encoderConfig: "1080p"
            });

            const screenContainer = document.getElementById("screen-share");
            screenContainer.innerHTML = "";
            screenTrack.play(screenContainer);

            await client.publish(screenTrack);
        } catch (e) {
            console.error(e);
            alert("ÙØ´Ù„ Ø¨Ø¯Ø¡ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø©");
        }
    }

    async function stopScreenShare() {
        if (screenTrack) {
            await client.unpublish(screenTrack);
            screenTrack.stop();
            screenTrack.close();
            screenTrack = null;

            document.getElementById("screen-share").innerHTML =
                "<p>ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø©</p>";
        }
    }
</script>
