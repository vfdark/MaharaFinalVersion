@model MaharaFinalVersion.Models.LiveSessionModel

@{
    ViewData["Title"] = "Ø¬Ù„Ø³Ø© Ù…Ø¨Ø§Ø´Ø±Ø© | Ù…Ù‡Ø§Ø±Ø©";
}

<link rel="stylesheet" href="~/css/live-session.css" />
<script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>

<div class="live-session-page">

    <header>
        <h1>@Model.Title</h1>
        <h3>Ø§Ù„Ù…Ø¹Ù„Ù…: @Model.Instructor</h3>
    </header>

    <main class="session-container">

        <!-- Screen Share Area -->
        <div id="screen-share" class="screen-share-area">
            <p id="screen-placeholder">Ù„Ù… ÙŠØªÙ… Ø¨Ø¯Ø¡ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø© Ø¨Ø¹Ø¯</p>
        </div>

        <!-- Participants -->
        <aside class="participants-list">
            <h2>Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙˆÙ†</h2>
            <ul id="participants">
                @foreach (var p in Model.Participants ?? new List<MaharaFinalVersion.Models.Participant>())
                {
                    <li class="@(p.IsSpeaking ? "speaking" : "")">
                        @if (p.IsHost) { <span class="host-badge">Ø§Ù„Ù…Ø¶ÙŠÙ</span> }
                        @p.Name
                    </li>
                }
            </ul>
        </aside>

        <!-- Chat -->
        <section class="chat-area">
            <h2>Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</h2>
            <div id="messages">
                @foreach (var msg in Model.Messages ?? new List<MaharaFinalVersion.Models.ChatMessage>())
                {
                    <p>@msg.Time - <strong>@msg.Sender:</strong> @msg.Message</p>
                }
            </div>
            <input type="text" id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." />
            <button id="sendBtn">Ø¥Ø±Ø³Ø§Ù„</button>
        </section>

    </main>

    @if (Model.IsHost)
    {
        <div class="live-controls">
            <button class="btn btn-primary" id="startBtn">ğŸ–¥ï¸ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø©</button>
            <button class="btn btn-danger" id="stopBtn" disabled>â›” Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©</button>
        </div>
    }

</div>

<footer>
    &copy; 2026 Ù…Ù‡Ø§Ø±Ø© - Live Session. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.
    <a href="#">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©</a>
</footer>

<script>
const APP_ID = "d0d5abfd738c42a2a956b631679d1971"; // your app ID
const CHANNEL = "@Html.Raw(Model.ChannelName)";
const IS_HOST = @Model.IsHost.ToString().ToLower();
let UID = Math.floor(Math.random() * 10000);
let TOKEN = "";
let joined = false;
let joining = false; // to prevent double join
let screenTrack = null;

// Create Agora client
const client = AgoraRTC.createClient({ 
    mode: "rtc", 
    codec: "vp8",
    enableLogUpload: false // disable stats to avoid CORS errors
});

// -------------------
// Get token
// -------------------
async function getToken() {
    if (TOKEN) return TOKEN;
    try {
        const res = await fetch(`/api/Agora/token?channelName=${CHANNEL}&uid=${UID}&isHost=${IS_HOST}`);
        const data = await res.json();
        TOKEN = data.token;
        console.log("âœ… Token fetched:", TOKEN);
        return TOKEN;
    } catch (err) {
        console.error("âŒ Failed to fetch token:", err);
        alert("ÙØ´Ù„ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù…Ù…ÙŠØ²: " + err.message);
    }
}

// -------------------
// Join channel safely
// -------------------
async function joinChannel() {
    if (joined) return;
    if (joining) return;
    joining = true;
    try {
        await getToken();
        await client.join(APP_ID, CHANNEL, TOKEN, UID);
        joined = true;
        console.log("âœ… Joined channel:", CHANNEL, "UID:", UID);
    } catch (err) {
        console.error("âŒ Failed to join channel:", err);
        alert("ÙØ´Ù„ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ù‚Ù†Ø§Ø©: " + err.message);
    } finally {
        joining = false;
    }
}

// -------------------
// Start screen share
// -------------------
async function startScreenShare() {
    try {
        if (!joined) await joinChannel();

        if (screenTrack) {
            console.warn("Screen already sharing");
            return;
        }

        screenTrack = await AgoraRTC.createScreenVideoTrack({ encoderConfig: "1080p", optimizationMode: "motion" });

        const container = document.getElementById("screen-share");
        container.innerHTML = "";
        screenTrack.play(container);

        await client.publish(screenTrack);
        console.log("âœ… Screen share started");

        document.getElementById("startBtn").disabled = true;
        document.getElementById("stopBtn").disabled = false;

    } catch (err) {
        console.error("âŒ Failed to start screen share:", err);
        alert("ÙØ´Ù„ Ø¨Ø¯Ø¡ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø©: " + err.message);
    }
}

// -------------------
// Stop screen share
// -------------------
async function stopScreenShare() {
    try {
        if (!joined) {
            alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ù„Ø£Ù†Ùƒ Ù„Ù… ØªÙ†Ø¶Ù… Ù„Ù„Ù‚Ù†Ø§Ø© Ø¨Ø¹Ø¯.");
            return;
        }

        if (!screenTrack) return;

        await client.unpublish(screenTrack);
        screenTrack.stop();
        screenTrack.close();
        screenTrack = null;

        const container = document.getElementById("screen-share");
        container.innerHTML = "<p>Ù„Ù… ÙŠØªÙ… Ø¨Ø¯Ø¡ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø© Ø¨Ø¹Ø¯</p>";

        console.log("âœ… Screen share stopped");

        document.getElementById("startBtn").disabled = false;
        document.getElementById("stopBtn").disabled = true;

    } catch (err) {
        console.error("âŒ Failed to stop screen share:", err);
        alert("ÙØ´Ù„ Ø¥ÙŠÙ‚Ø§Ù Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø©: " + err.message);
    }
}

// -------------------
// DOM events
// -------------------
document.addEventListener("DOMContentLoaded", async () => {
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");

    startBtn.disabled = false;
    stopBtn.disabled = true;

    startBtn.addEventListener("click", startScreenShare);
    stopBtn.addEventListener("click", stopScreenShare);

    if (IS_HOST) await joinChannel();
});
</script>
